# moz-offgrid-viz
Front visualization tool for Mozambique Off-Grid Energy project.

The data and preparation methods for this project are in a separate repository: [moz-offgrid-data](https://github.com/carderne/moz-offgrid-data).

## Stack
This repo contains the files and tools needed to create a static website for exploring the various data layers.

It requires the following to be deployed:
- Data preparation using Python 3.7.3+
- Any static website hosting platform (currently Netlify)
- Mapbox Studio serving the map tiles and styles

The only JavaScript dependency is Mapbox GL JS, which is loaded from `vendor/`.
The required Python libraries for data and template preparation are listed in `requirements.txt` and can be installed with:
```
pip install -r requirements.txt
```

## NB
Remove `?fresh=true` from map style URL before publishing.

## Local development
To serve locally, install and use `light-server`:
```
npm install --global light-server
light-server -s .
```

This will create a localhost server at `0.0.0.0:4000`.

## Main directories
```
├── data/                    # geojson and mbtiles served via Mapbox
├── download/                # files to be downloaded via frontend
├── templates/               # language files, templates and parsing script
├── index.html               # generated home page
├── pt/                      # generated Portuguese version
└── docs/                    # generated help docs
```

## Editing
The final HTML files served are generated by script and should not be edited. The HTML templates that can be edited for the tool and the docs are in `./templates/`. Their respective language files for English `en` and Portuguese `pt` are in the same directory. These four files define the structure and text content of the pages.

The JavaScript `.js` and CSS `.css` files in the root and in `./docs/` can be edited directly, as they are not modified by script.

To re-generate the outputs files after modifying the templates or language files, run the script:
```bash
./templates/parse.py
```

Or
```bash
find templates/ | entr ./templates/parse.py
```

This generates the following files:
```
./index.html
./pt/index.html
./docs/index.html
./docs/pt/index.html
```

## Data preparation
All data outputs from the main data preparation process are saved as GeoPackages `.gpkg`. These need to be converted to GeoJSON and MBTiles for serving online, and to other formats for user downloads.

### Clusters and admin to GeoJSON
Use the script to convert clusters to GeoJSON:
```bash
./data/convert_clusters.py ../data/clusters/clu-man-feat.gpkg ./data/clusters.geojson
```

Convert adm files and create centroids:
```bash
./data/convert_adm.py ../data/admin/ ./data/
```

### Create files for download
Need to use QGIS to manually convert clusters and adm files to CSV and KML.

In the case of adm files, the CSV is converted to an Excel spreadsheet with a tab for each administrative level (province, district and posto).

### Convert GeoJSON to MBtiles
For displaying in the Mapbox webmap, most of the data layers need to be converted to MBtiles. For vector layers, use [tippecanoe](https://github.com/mapbox/tippecanoe), and for raster layers (only the S2 imagery), use [rio-mbtiles](https://github.com/mapbox/rio-mbtiles).

For clusters:
```
# -z highest level
# -Z lowest level
# -o output file
# -as drop as needed
# -l layer name
# -f force
# -ai generate unique ids
tippecanoe -o ./data/clusters.mbtiles -Z5 -z10 -as -ai -l clusters -f ./data/clusters.geojson
```

For adm layers:
```
tippecanoe -o ./data/adm3.mbtiles -Z5 -z10 -as -l adm3 -f ./data/adm3.geojson
```

For grid:
```
tippecanoe -o ./data/grid.mbtiles -Z5 -z10 -as -l grid -f ./data/grid.geojson
```

For S2 imagery (not that this can take many hours to process):
```bash
pip install rio-mbtiles
rio mbtiles s2_mosaic_byte.tif -o s2_mosaic_byte_rio_5_14.mbtiles --zoom-levels 5..14 -f JPEG --title s2 --src-nodata 0 --dst-nodata 0 -j 4
```

Use the replace functionality on Mapbox Studio to replace tilesets, rather than uploading new ones.

### Buffered inverted border outline
Uses [Natural Earth Admin 0](https://www.naturalearthdata.com/downloads/10m-cultural-vectors/) admin layer. Following steps in QGIS.

1. First need to create a square covering the earth. Use `Create layer from extent` with the admin layer for the whole earth.
2. Then filter the admin layer with `"SOV_A3" = 'MOZ'` and buffer by 0.2 degrees.
3. Then use vector `Difference` to subtract the buffered Mozambique from the big square.
4. Save as GeoJSON for loading in Mapbox Studio.
